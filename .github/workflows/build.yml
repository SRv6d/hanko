---
name: Build

on:
  release:
    types: [published]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    permissions:
      contents: write
      packages: write
      id-token: write
      attestations: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - uses: DeterminateSystems/nix-installer-action@e50d5f73bfe71c2dd0aa4218de8f4afa59f8f81d # v16

      - name: Build release artifacts
        run: nix build .#release-artifacts --out-link release-artifacts

      - name: Upload release artifacts
        run: gh release upload --clobber "${GITHUB_REF_NAME}" release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Container Registry login
        if: runner.os == 'Linux'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image metadata
        if: runner.os == 'Linux'
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.ref_name }}
      
      - name: Build and push container images
        if: runner.os == 'Linux'
        id: containers
        run: |
          base_tag="${{ steps.meta.outputs.tags }}"
          subject_name="${base_tag%%:*}"
          nix build .#release-containers --out-link release-containers
          arch_tags=()
          for img in release-containers/*.tar.gz; do
            arch=$(basename "$img" .tar.gz)
            docker load < "$img"
            tag="${base_tag}-${arch}"
            docker tag "hanko:${GITHUB_REF_NAME#v}" "$tag"
            docker push "$tag"
            arch_tags+=("$tag")
          done
          docker buildx imagetools create \
            --tag "${base_tag}" \
            "${arch_tags[@]}"
          digest=$(docker buildx imagetools inspect \
            --format '{{json .Manifest}}' \
            "${base_tag}" | jq -r '.digest')
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"
          echo "subject_name=${subject_name}" >> "$GITHUB_OUTPUT"

      - name: Attest container image
        if: runner.os == 'Linux'
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f
        with:
          subject-name: ${{ steps.containers.outputs.subject_name }}
          subject-digest: ${{ steps.containers.outputs.digest }}
          push-to-registry: true

  attest-build-provenance:
    permissions:
      id-token: write
      attestations: write
      contents: write
    needs: build
    runs-on: ubuntu-latest
    env:
      DOWNLOAD_DIR: release-files
    steps:
      - name: Download release files
        run: >-
          gh release download "${GITHUB_REF_NAME}" --dir ${DOWNLOAD_DIR} --pattern "hanko-*"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Attest release files
        id: provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f
        with:
          subject-path: ${{ env.DOWNLOAD_DIR }}/*

      - name: Upload provenance
        run: gh release upload --clobber "${GITHUB_REF_NAME}" ${{ steps.provenance.outputs.bundle-path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
